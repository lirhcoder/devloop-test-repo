# DevLoop — AI Agent-Based Issue Resolution Workflow
# Generated by Osmill DevLoop skill. Template variables use {{ALL_CAPS}} syntax.
#
# Prerequisites:
#   1. Set ANTHROPIC_API_KEY as a repository secret
#   2. Copy devloop-config.yaml to repo root
#   3. Add DevLoop section to CLAUDE.md
#   4. Create DevLoop labels (use /devloop setup)

name: DevLoop

on:
  issues:
    types: [labeled]

# Cancel in-progress runs for the same issue
concurrency:
  group: devloop-${{ github.event.issue.number }}
  cancel-in-progress: true

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  # ──────────────────────────────────────────────
  # Phase 1: Triage
  # Trigger: issue labeled "devloop"
  # Goal: Analyze issue, identify root cause, add ready-to-fix label
  # ──────────────────────────────────────────────
  triage:
    if: >-
      github.event.label.name == 'devloop' &&
      !contains(github.event.issue.labels.*.name, 'devloop:triaging')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Add triaging label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "devloop:triaging"

      - name: Triage with Claude
        id: triage_claude
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: "--max-turns 10 --allowedTools Read,Glob,Grep,Bash"
          prompt: |
            You are triaging issue #${{ github.event.issue.number }}.

            ## Issue
            Title: ${{ github.event.issue.title }}
            Body: ${{ github.event.issue.body }}

            ## Instructions
            1. Read the issue carefully and understand the reported problem.
            2. Search the codebase for relevant files and code paths.
            3. Form a hypothesis about the root cause.
            4. Post a triage comment on the issue with:
               - **Affected files**: List files likely involved
               - **Root cause hypothesis**: Your best understanding of what's wrong
               - **Suggested approach**: How to fix it
               - **Confidence**: High / Medium / Low
               - **Estimated complexity**: Simple / Moderate / Complex
            5. If confidence is Medium or High and complexity is not Complex:
               - Remove the triaging label and add the ready-to-fix label.
            6. If confidence is Low or complexity is Complex:
               - Remove the triaging label and add the needs-human label.
               - Explain why human intervention is needed.

      - name: Check triage outcome
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LABELS=$(gh issue view ${{ github.event.issue.number }} --json labels --jq '.labels[].name')
          if echo "$LABELS" | grep -q "devloop:ready-to-fix\|devloop:needs-human"; then
            echo "Triage completed successfully."
          elif [ "${{ steps.triage_claude.outcome }}" = "failure" ]; then
            gh issue edit ${{ github.event.issue.number }} \
              --remove-label "devloop:triaging" \
              --add-label "devloop:failed"
            gh issue comment ${{ github.event.issue.number }} \
              --body "DevLoop triage failed. Check [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details."
          fi

  # ──────────────────────────────────────────────
  # Phase 2: Fix
  # Trigger: issue labeled "devloop:ready-to-fix"
  # Goal: Fix code, run tests, create PR
  # ──────────────────────────────────────────────
  fix:
    if: github.event.label.name == 'devloop:ready-to-fix'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f pyproject.toml ]; then pip install -e ".[dev]" 2>/dev/null || pip install -e .; fi

      - name: Add fixing label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "devloop:fixing"

      - name: Fix with Claude
        id: fix_claude
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: "--max-turns 25 --allowedTools Read,Write,Edit,Glob,Grep,Bash"
          prompt: |
            You are fixing issue #${{ github.event.issue.number }}.

            ## Issue
            Title: ${{ github.event.issue.title }}
            Body: ${{ github.event.issue.body }}

            ## Instructions
            1. Read the issue and any triage comments for context.
            2. Investigate the codebase to confirm the root cause.
            3. Implement the fix:
               - Make minimal, focused changes
               - Add or update tests to cover the fix
               - Follow the project's code style (see CLAUDE.md)
            4. Run the test suite: `pytest`
               - If tests fail, analyze the failure and iterate on your fix.
               - You may retry within your turn budget.
            5. Once tests pass, create a PR:
               - Branch: `devloop/fix-${{ github.event.issue.number }}`
               - Title: `fix: <description> (#${{ github.event.issue.number }})`
               - Body: root cause, fix description, test results
               - Link the PR to this issue with "Closes #${{ github.event.issue.number }}"
            6. After PR creation:
               - Remove the fixing label
               - Add the pr-created label

            ## Constraints
            - Do NOT modify CI/CD files, migrations, or auth logic.
            - Do NOT change dependencies unless strictly necessary for the fix.
            - Stay within the scope of this issue.

      - name: Check fix outcome
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LABELS=$(gh issue view ${{ github.event.issue.number }} --json labels --jq '.labels[].name')
          if echo "$LABELS" | grep -q "devloop:pr-created"; then
            echo "Fix completed successfully — PR created."
          elif [ "${{ steps.fix_claude.outcome }}" = "failure" ]; then
            gh issue edit ${{ github.event.issue.number }} \
              --remove-label "devloop:fixing" \
              --add-label "devloop:failed"
            gh issue comment ${{ github.event.issue.number }} \
              --body "DevLoop fix attempt failed. Check [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details."
          fi

  # ──────────────────────────────────────────────
  # Phase 3: Verify
  # Trigger: issue labeled "devloop:deployed"
  # Goal: Run tests post-deploy, close issue or create follow-up
  # ──────────────────────────────────────────────
  verify:
    if: github.event.label.name == 'devloop:deployed'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f pyproject.toml ]; then pip install -e ".[dev]" 2>/dev/null || pip install -e .; fi

      - name: Verify with Claude
        id: verify_claude
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: "--max-turns 10 --allowedTools Read,Glob,Grep,Bash"
          prompt: |
            You are verifying that issue #${{ github.event.issue.number }} has been fixed.

            ## Issue
            Title: ${{ github.event.issue.title }}
            Body: ${{ github.event.issue.body }}

            ## Instructions
            1. Read the issue and related PR to understand what was fixed.
            2. Run the test suite: `pytest`
            3. If all tests pass:
               - Add the verified label
               - Close the issue with a comment confirming verification
            4. If tests fail:
               - Add the failed label
               - Create a NEW issue referencing this one:
                 - Title: "Regression: <original title> (follow-up from #${{ github.event.issue.number }})"
                 - Body: test failure details and link to the original issue
                 - Add the devloop label to trigger re-investigation

      - name: Check verify outcome
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LABELS=$(gh issue view ${{ github.event.issue.number }} --json labels --jq '.labels[].name')
          if echo "$LABELS" | grep -q "devloop:verified"; then
            echo "Verification passed."
          elif [ "${{ steps.verify_claude.outcome }}" = "failure" ]; then
            gh issue edit ${{ github.event.issue.number }} \
              --add-label "devloop:failed"
            gh issue comment ${{ github.event.issue.number }} \
              --body "DevLoop verification failed. Check [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details."
          fi
